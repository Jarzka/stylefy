{"version":3,"sources":["stylefy/impl/cache.cljs"],"mappings":"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","names":["stylefy.impl.cache/cache-prefix","stylefy.impl.cache/cache-styles?","cljs.core.atom","stylefy.impl.cache/default-cache-expiration-time-s","cljs.core/*","stylefy.impl.cache/cache-key-styles","instance-id","stylefy.impl.cache/cache-key-created","stylefy.impl.cache/now-in-seconds","js/Math","js/Date","stylefy.impl.cache/cache-expired?","cache-created","expiration-age","now","and__4109__auto__","stylefy.impl.cache/read-cache-value","key","cljs.core/deref","temp__5735__auto__","cache-contents","js/window","cljs.reader.read_string","var_args","G__35623","stylefy.impl.cache/set-cache-created-time","js/Error","time-created","stylefy.impl.cache.set_cache_created_time","G__35631","stylefy.impl.cache/clear-styles","stylefy.impl.cache.clear_styles","G__35635","stylefy.impl.cache/use-caching!","cache-options","stylefy.impl.cache.use_caching_BANG_","cljs.core/reset!","or__4120__auto__","G__35644","stylefy.impl.cache/cache-styles","styles","stylefy.impl.cache.cache_styles","cljs.core/map?"],"sourcesContent":["(ns stylefy.impl.cache\n  (:require [cljs.reader :refer [read-string]]))\n\n(def cache-prefix \"stylefy_cache_\")\n(def cache-styles? (atom false))\n(def default-cache-expiration-time-s (* 1 60 60 * 24 * 7))\n\n(defn cache-key-styles [instance-id]\n  (str cache-prefix \"styles\"\n       (when instance-id\n         (str \"_\" instance-id))))\n\n(defn- cache-key-created [instance-id]\n  (str cache-prefix \"created\"\n       (when instance-id\n         (str \"_\" instance-id))))\n\n; Utils\n\n(defn now-in-seconds []\n  (.floor js/Math (/ (.now js/Date) 1000)))\n\n(defn cache-expired? [cache-created expiration-age now]\n  (if (and cache-created expiration-age)\n    (< (+ cache-created expiration-age) now)\n    false))\n\n; Cache reading\n\n(defn read-cache-value\n  \"Reads the cache if caching is used.\"\n  [key]\n  (when @cache-styles?\n    (when-let [cache-contents (.getItem (.-localStorage js/window) key)]\n      (read-string cache-contents))))\n\n; Cache manipulation\n\n(defn set-cache-created-time\n  ([time-created]\n   (set-cache-created-time time-created nil))\n  ([time-created instance-id]\n   (.setItem (.-localStorage js/window)\n             (cache-key-created instance-id)\n             time-created)))\n\n(defn clear-styles\n  ([]\n   (clear-styles nil))\n  ([instance-id]\n   (.setItem (.-localStorage js/window)\n             (cache-key-styles instance-id)\n             \"\")))\n\n(defn use-caching!\n  ([cache-options]\n   (use-caching! cache-options nil))\n  ([cache-options instance-id]\n   (reset! cache-styles? true)\n\n    ; If cache is empty, set creation date.\n   (when-not (read-cache-value (cache-key-created instance-id))\n     (set-cache-created-time (now-in-seconds) instance-id))\n\n   (when (cache-expired? (read-cache-value (cache-key-created instance-id))\n                         (or (:expires cache-options) default-cache-expiration-time-s)\n                         (now-in-seconds))\n     (clear-styles instance-id)\n     (set-cache-created-time (now-in-seconds) instance-id))))\n\n(defn cache-styles\n  \"Caches the given style if caching is used.\n  Throws QUOTA_EXCEEDED_ERR if the storage is full.\"\n  ([styles]\n   (cache-styles styles nil))\n  ([styles instance-id]\n   (when (and @cache-styles? (map? styles))\n     (.setItem (.-localStorage js/window)\n               (cache-key-styles instance-id)\n               styles))))\n"]}